machine:
  environment:
    _JAVA_OPTIONS: "-Xms512m -Xmx1024m"
    GRADLE_OPTS: '-Dorg.gradle.parallel=false -Dorg.gradle.jvmargs="-Xmx1024m -XX:+HeapDumpOnOutOfMemoryError"'
dependencies:
  pre:
    # CircleCI shallow clones repositories, unshallow this repository if needed.
    - "[[ ! -s \"$(git rev-parse --git-dir)/shallow\" ]] || git fetch --unshallow"

    # https://discuss.circleci.com/t/bundler-fails-to-find-appropriate-version-despite-installing-appropriate-version-earlier-in-the-build/2815/33
    - rvm install rubygems 2.4.8 --force
    - gem install bundler -v 1.12.5

    - echo y | android update sdk --no-ui --all --filter "build-tools-23.0.1"
    - bundle install
    - npm install --no-progress --no-spin:
        pwd: ares
    - cp gradle.ci.properties gradle.properties:
        pwd: ares/android
  cache_directories:
    - ~/.gradle
    - ~/.android
    - ./.bundle
    - ./vendor
    - ./ares/node_modules
    - ./ares/android/.gradle/
test:
  override:
    - fastlane react_native_test
    - fastlane android test
  post:
    - cp -r ares/android/app/build/test-results/* $CIRCLE_TEST_REPORTS
deployment:
  staging:
    branch: master
    commands:
      - ./ci/decode-secrets.sh
      - fastlane android staging
notify:
  webhooks:
    - url: http://mcc.aphelion.io/builds/3/hook/circle
