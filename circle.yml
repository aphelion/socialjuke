machine:
  environment:
    GRADLE_OPTS: '-Dorg.gradle.parallel=false -Dorg.gradle.jvmargs="-Xms512m -Xmx512m"'
dependencies:
  pre:
    # https://discuss.circleci.com/t/bundler-fails-to-find-appropriate-version-despite-installing-appropriate-version-earlier-in-the-build/2815/33
    - rvm install rubygems 2.4.8 --force
    - gem install bundler -v 1.12.5

    - bundle install
    - npm install --no-progress --no-spin:
        pwd: ares
    - echo y | android update sdk --no-ui --all --filter "build-tools-23.0.1"
  cache_directories:
    - ./ares/node_modules
test:
  override:
    - fastlane react_native_test
    - fastlane android test
  post:
    - cp -r ares/android/app/build/test-results/* $CIRCLE_TEST_REPORTS
deployment:
  staging:
    branch: master
    commands:
      - ./ci/decode-secrets.sh
      - fastlane android staging
notify:
  webhooks:
    - url: http://mcc.aphelion.io/builds/3/hook/circle
